<!DOCTYPE html>
<html>
<head>
  <title>Admin Shop Approval Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f2f2f2;
    }
    header {
      background-color: #1a73e8;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h2 {
      margin: 0;
    }
    header button {
      background: red;
      color: white;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 5px;
    }
    .container {
      padding: 20px;
    }
    .shop-card {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
    }
    .shop-card img {
      width: 150px;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
    }
    .shop-details {
      flex-grow: 1;
    }
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    .approve-btn {
      background-color: green;
      color: white;
    }
    .reject-btn {
      background-color: darkred;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <h2>Admin - Pending Shop Approvals</h2>
    <button onclick="logout()">Logout</button>
  </header>

  <div class="container" id="shopList">
    Loading shops...
  </div>

  <!-- Firebase SDKs -->
 <!-- KEEP THIS SCRIPT BLOCK -->
<script type="module">
  import { auth, db, storage } from './firebase.js'; // Import from your central file
       import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
       import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Logout function
    function logout() {
      auth.signOut().then(() => window.location.href = "index.html");
    }

    // Auth state check
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        loadPendingShops();
      }
    });

    // 1. Make sure to import the necessary v9 functions from Firebase
// import { collection, query, where, getDocs, doc, updateDoc, deleteDoc } from "firebase/firestore";
// import { db } from './firebase.js'; // Assuming db is exported from your config file

const shopList = document.getElementById("shopList");

/**
 * Fetches unapproved caterers from Firestore and renders them to the page.
 * Uses modern async/await syntax and error handling.
 */
async function loadPendingShops() {
  shopList.innerHTML = "<p>Loading pending approvals...</p>";

  try {
    // Use the v9 syntax for querying Firestore
    const caterersRef = collection(db, "caterers");
    const q = query(caterersRef, where("approved", "==", false));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      shopList.innerHTML = "<p>No pending shops for approval.</p>";
      return;
    }

    // Clear the list before adding new items
    shopList.innerHTML = "";

    snapshot.forEach(doc => {
      const shop = doc.data();
      const shopCard = document.createElement("div");
      shopCard.className = "shop-card";
      shopCard.id = `shop-${doc.id}`; // Add an ID for easy removal later

      // Use data-* attributes for event handling instead of inline onclick
      shopCard.innerHTML = `
        <img src="${shop.imageUrl}" alt="${shop.shopName}">
        <div class="shop-details">
          <h3>${shop.shopName}</h3>
          <p><strong>Owner:</strong> ${shop.ownerName}</p>
          <p><strong>Email:</strong> ${shop.email}</p>
          <p><strong>Description:</strong> ${shop.shopDescription}</p>
          <p><strong>Address:</strong> ${shop.address}</p>
          <button class="btn approve-btn" data-id="${doc.id}">Approve</button>
          <button class="btn reject-btn" data-id="${doc.id}">Reject</button>
        </div>
      `;
      shopList.appendChild(shopCard);
    });
  } catch (error) {
    console.error("Error loading pending shops:", error);
    shopList.innerHTML = "<p style='color: red;'>Could not load data. Please try again.</p>";
  }
}

/**
 * Use a single event listener on the parent container (event delegation).
 * This is more efficient than adding a listener to every button.
 */
shopList.addEventListener('click', async (event) => {
  const button = event.target;
  const shopId = button.dataset.id;

  if (!shopId) return; // Exit if the click wasn't on a button with a data-id

  // --- Approve Logic ---
  if (button.classList.contains('approve-btn')) {
    button.disabled = true;
    button.textContent = "Approving...";
    try {
      const shopRef = doc(db, "caterers", shopId);
      await updateDoc(shopRef, { approved: true });
      alert("Shop approved!");
      document.getElementById(`shop-${shopId}`).remove(); // Remove card from UI
    } catch (error) {
      console.error("Error approving shop:", error);
      alert("Failed to approve shop. Please check the console.");
      button.disabled = false;
      button.textContent = "Approve";
    }
  }

  // --- Reject Logic ---
  if (button.classList.contains('reject-btn')) {
    if (confirm("Are you sure you want to reject and delete this shop?")) {
      button.disabled = true;
      button.textContent = "Rejecting...";
      try {
        const shopRef = doc(db, "caterers", shopId);
        await deleteDoc(shopRef);
        alert("Shop rejected and deleted.");
        document.getElementById(`shop-${shopId}`).remove(); // Remove card from UI
      } catch (error) {
        console.error("Error rejecting shop:", error);
        alert("Failed to reject shop. Please check the console.");
        button.disabled = false;
        button.textContent = "Reject";
      }
    }
  }
});

// Initial call to load the data when the page loads
loadPendingShops();
  </script>
</body>
</html>
