<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catering Login</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,0&icon_names=visibility,visibility_off" />
    <style>
      body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; padding: 40px 15px; min-height: 100vh; margin: 0; }
      .auth-container { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); width: 100%; max-width: 420px; box-sizing: border-box; }
      h2 { margin-bottom: 25px; color: #333; text-align: center; font-weight: 600; }
      
      .role-toggle { display: flex; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 25px; overflow: hidden; }
      .role-toggle button {
        flex: 1; padding: 12px; border: none; background-color: #f8f9fa; color: #555;
        font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
      }
      .role-toggle button.active { background-color: #1a73e8; color: white; }
      .role-toggle button:first-child { border-right: 1px solid #ccc; }

      .form-field, .password-wrapper { margin-bottom: 15px; }
      input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
      .password-wrapper { position: relative; }
      .password-wrapper input { padding-right: 45px; }
      .toggle-password { position: absolute; top: 50%; right: 12px; transform: translateY(-50%); cursor: pointer; color: #555; user-select: none; }
      
      button[type="submit"] { width: 100%; padding: 12px; margin-top: 10px; background-color: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
      button[type="submit"]:disabled { background-color: #9ecaed; cursor: not-allowed; }
      button[type="submit"]:hover:not(:disabled) { background-color: #0f5eea; }
      
      .footer-links { text-align: center; margin-top: 20px; }
      .footer-links a { color: #1a73e8; font-weight: 500; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="auth-container">
    <h2 id="formTitle">Login</h2>
    <div class="role-toggle">
        <button id="user-role-btn" class="active" onclick="setRole('user')">User</button>
        <button id="admin-role-btn" onclick="setRole('admin')">Admin</button>
    </div>
    <form id="loginForm">
        <div class="form-field"><input type="email" id="loginEmail" placeholder="Email" required /></div>
        <div class="password-wrapper">
            <input type="password" id="loginPassword" placeholder="Password" required />
            <span class="material-symbols-outlined toggle-password" onclick="togglePasswordVisibility('loginPassword')">visibility</span>
        </div>
        <button type="submit" id="submitBtn">Login</button>
    </form>
    
    <div class="footer-links">
        <!-- âœ¨ FIX: This now correctly links to your register.html page -->
        <a href="register.html">Don't have an account? Register</a>
        <br><br>
        <a href="super_admin_login.html">Super Admin Login</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    // Import the database instance from your firebase config file
import { db } from './firebase.js';
    const firebaseConfig = {
  apiKey: "AIzaSyCsIFvtzzbx3OYXZr2MKCk7ml8jZvKUOVs",
  authDomain: "hunger-games-cb40e.firebaseapp.com",
  projectId: "hunger-games-cb40e",
  storageBucket: "hunger-games-cb40e.firebasestorage.app",
  messagingSenderId: "1002369787131",
  appId: "1:1002369787131:web:39e602e3440d5fd6a1fc5e"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentLoginRole = 'user';

    // --- UI Logic ---
    window.setRole = function(role) {
        currentLoginRole = role;
        document.getElementById('user-role-btn').classList.toggle('active', role === 'user');
        document.getElementById('admin-role-btn').classList.toggle('active', role === 'admin');
    }

    window.togglePasswordVisibility = function(inputId) {
        const pwdInput = document.getElementById(inputId);
        const toggleIcon = pwdInput.nextElementSibling;
        pwdInput.type = pwdInput.type === "password" ? "text" : "password";
        toggleIcon.textContent = pwdInput.type === "password" ? "visibility" : "visibility_off";
    }
    
    // --- Authentication Logic ---
    document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        handleLogin();
    });

    async function handleLogin() {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const submitBtn = document.getElementById('submitBtn');

        if (!email || !password) {
            return alert("Please fill all fields.");
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Logging in...';

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Check the /admins collection first if logging in as admin
            if (currentLoginRole === 'admin') {
                const adminDocRef = doc(db, "admins", uid);
                const adminDoc = await getDoc(adminDocRef);
                if (adminDoc.exists()) {
                     if (adminDoc.data().approved) {
                        window.location.href = "admin.html";
                    } else {
                        window.location.href = "admin_waiting_approval.html";
                    }
                    return; // Stop execution here
                } else {
                    throw new Error(`This account is not registered as an Admin.`);
                }
            }
            
            // Check the /users collection if logging in as user
            if (currentLoginRole === 'user') {
                const userDocRef = doc(db, "users", uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    window.location.href = "user.html";
                    return; // Stop execution here
                } else {
                     throw new Error(`This account is not registered as a User.`);
                }
            }
            
        } catch (error) {
            alert(`Login failed: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Login';
        }
    }
</script>
</body>
</html>
