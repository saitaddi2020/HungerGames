<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary-color: #ff6f61;
      --primary-gradient: linear-gradient(135deg, #ff8c61 0%, #ff6f61 100%);
      --accent-color: #4CAF50;
      --background-color: #f7f8fc;
      --surface-color: #ffffff;
      --text-color: #2c3e50;
      --text-color-light: #8492a6;
      --border-color: #e8eaf0;
      --radius: 16px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.07);
    }

    * { box-sizing: border-box; }

    body {
      background-color: var(--background-color);
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
      margin: 0;
      color: var(--text-color);
    }

    .dashboard-container {
      max-width: 1024px;
      margin: 32px auto;
      background-color: var(--surface-color);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: 85vh;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }

    .tab {
      flex: 1;
      padding: 18px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-color-light);
      transition: color 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .tab:hover { color: var(--primary-color); }
    .tab.active { color: var(--primary-color); }

    .tab-glider {
      position: absolute;
      height: 3px;
      bottom: -1px;
      background: var(--primary-color);
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .section {
      display: none;
      padding: 32px;
      animation: fadeIn 0.5s ease-out;
    }
    .section.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* PROFILE */
    .profile-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 20px 0;
    }
    #userProfilePic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--primary-color);
      box-shadow: 0 4px 20px rgba(255, 111, 97, 0.4);
      margin-bottom: 20px;
    }
    #userFullName { font-weight: 600; font-size: 1.5rem; margin-bottom: 4px; }
    #userEmail { color: var(--text-color-light); font-size: 1.1rem; }

    /* GENERAL BUTTON STYLE */
    .btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 12px 32px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 111, 97, 0.3);
      background-size: 200% auto;
    }
    .btn:hover {
      background-position: right center;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 111, 97, 0.4);
    }
    #logoutBtn { margin-top: 30px; }

    /* SHOPS */
    .filters-bar { display: flex; gap: 16px; margin-bottom: 28px; }
    .filter, .search-input {
      padding: 12px 18px;
      border: 1px solid var(--border-color);
      border-radius: 50px;
      background: #fff;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
    }
    .search-input { flex: 1; }
    .filter:focus, .search-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 111, 97, 0.2);
    }
    #shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
    }
    .shop-card {
      text-decoration: none;
      color: inherit;
      background: var(--surface-color);
      border-radius: var(--radius);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .shop-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
    }
    .shop-card img { width: 100%; height: 160px; object-fit: cover; }
    .shop-card-content { padding: 20px; }
    .shop-card-content h3 { margin: 0 0 8px; color: var(--text-color); }
    .shop-card-content p { margin: 0 0 12px; color: var(--text-color-light); font-size: 0.95rem; }
    .category-tag {
      background-color: rgba(255, 111, 97, 0.1);
      color: var(--primary-color);
      font-size: 0.85rem;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 50px;
      display: inline-block;
    }
    
    /* CART & ORDERS */
    .list-item {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }
    .cart-item { display: flex; align-items: center; justify-content: space-between; }
    .empty-state { padding: 40px 20px; text-align: center; color: var(--text-color-light); font-size: 1.1rem; }
    .cart-total { margin: 24px 0; text-align: right; font-size: 1.2rem; font-weight: 600; }
    .place-order-btn { display: block; margin-left: auto; }

    .order-item div { margin-bottom: 8px; }
    .order-item div:last-child { margin-bottom: 0; }
    .order-status { font-weight: 600; color: var(--accent-color); }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #2c3e50;
      color: #fff;
      border-radius: 50px;
      padding: 14px 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
    }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

    @media (max-width: 768px) {
      body { padding: 0; }
      .dashboard-container { margin: 0; border-radius: 0; min-height: 100vh; }
      .filters-bar { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="tabs">
      <div class="tab active" data-section="profile">Profile</div>
      <div class="tab" data-section="shops">Shops</div>
      <div class="tab" data-section="cart">Cart</div>
      <div class="tab" data-section="orders">Orders</div>
      <span class="tab-glider"></span>
    </div>

    <div class="section active" id="profile-section">
      <div class="profile-box">
        <img id="userProfilePic" src="https://placehold.co/120x120/FFECEB/FF6F61?text=U" alt="Profile Picture" />
        <div id="userFullName">Loading...</div>
        <div id="userEmail"></div>
      </div>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>

    <div class="section" id="shops-section">
      <div class="filters-bar">
        <input class="search-input" id="search-input" autocomplete="off" placeholder="Search caterers...">
        <select class="filter" id="category-filter">
          <option value="all">All Categories</option>
          <option value="veg">Veg</option>
          <option value="non-veg">Non-Veg</option>
        </select>
      </div>
      <div id="shop-grid"><div class="empty-state">Loading shops...</div></div>
    </div>

    <div class="section" id="cart-section">
      <h2>Your Cart</h2>
      <div id="cart-items" class="cart-list"></div>
      <div id="cart-total"></div>
      <button class="btn place-order-btn">Place Order</button>
    </div>

    <div class="section" id="orders-section">
      <h2>Order History</h2>
      <div id="order-history"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // âœ¨ FIX: Import services from your central firebase.js file
    import { auth, db } from './firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import {
      collection, query, where, onSnapshot, doc,
      getDocs, deleteDoc, writeBatch, serverTimestamp,
      getDoc, orderBy
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // === STATE ===
    let currentUser = null;
    let allCaterers = [];
    let cartUnsubscribe = null;

    // === UI ELEMENTS ===
    const tabs = document.querySelectorAll('.tab');
    const glider = document.querySelector('.tab-glider');
    const sections = document.querySelectorAll('.section');

    // === TAB NAVIGATION ===
    tabs.forEach((tab, index) => {
      tab.addEventListener('click', () => {
        // Move glider
        const tabWidth = tab.offsetWidth;
        const tabLeft = tab.offsetLeft;
        glider.style.width = `${tabWidth}px`;
        glider.style.left = `${tabLeft}px`;

        // Update active classes
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        sections.forEach(s => s.classList.remove('active'));
        document.getElementById(`${tab.dataset.section}-section`).classList.add('active');
      });
    });

    // Initialize glider position
    function initGlider() {
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        glider.style.width = `${activeTab.offsetWidth}px`;
        glider.style.left = `${activeTab.offsetLeft}px`;
      }
    }

    // === TOAST NOTIFICATION ===
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // === AUTHENTICATION ===
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loadUserProfile();
        loadCaterers();
        loadOrderHistory();
        listenForCartUpdates();
        initGlider(); // Set glider after content might affect width
      } else {
        window.location.href = 'index.html';
      }
    });

    // === PROFILE & LOGOUT ===
    async function loadUserProfile() {
      const userDocRef = doc(db, "users", currentUser.uid);
      const userDoc = await getDoc(userDocRef);
      if (userDoc.exists()) {
        const userData = userDoc.data();
        const profilePic = document.getElementById('userProfilePic');
        
        document.getElementById('userFullName').textContent = userData.fullName || 'User';
        document.getElementById('userEmail').textContent = userData.email || '';
        
        if (userData.profilePicUrl) {
          profilePic.src = userData.profilePicUrl;
          // âœ¨ FIX: Fallback if the stored image URL is broken or invalid
          profilePic.onerror = () => {
            profilePic.src = 'https://placehold.co/120x120/FFECEB/FF6F61?text=U';
            console.warn("Profile picture failed to load. Using fallback.");
          };
        }
      }
    }
    
    // âœ¨ FIX: Modern event handling for logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).catch(error => showToast(`Logout failed: ${error.message}`));
    });

    // === SHOPS (Data Fetching & Rendering) ===
    async function loadCaterers() {
      try {
        const caterersRef = collection(db, "admins");
        const q = query(caterersRef, where("approved", "==", true));
        const snapshot = await getDocs(q);
        allCaterers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderCaterers(allCaterers);
      } catch (error) {
        showToast("Could not load caterers.");
        console.error("Error loading caterers: ", error);
      }
    }

    function renderCaterers(caterers) {
      const grid = document.getElementById('shop-grid');
      grid.innerHTML = '';
      if (!caterers || caterers.length === 0) {
        grid.innerHTML = '<p class="empty-state">No caterers found.</p>';
        return;
      }
      caterers.forEach(caterer => {
        const card = document.createElement('a');
        card.className = 'shop-card';
        
        // FIX: Using 'shopName' for consistency with your other pages.
        card.href = `shop_profile.html?username=${encodeURIComponent(caterer.shopName)}`;
        
        // FIX: This is the corrected HTML structure without comments.
        card.innerHTML = `
          <img src="${caterer.shopImageUrl || 'https://placehold.co/600x400/FFECEB/FFFFFF?text=Shop'}" alt="${caterer.shopName}">
          <div class="shop-card-content">
            <h3>${caterer.shopName || 'Unnamed Shop'}</h3>
            <p>${caterer.description || 'No description available.'}</p>
            <span class="category-tag">${caterer.category || 'General'}</span>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    // --- Shop Filtering ---
    document.getElementById('search-input').addEventListener('input', handleFilterChange);
    document.getElementById('category-filter').addEventListener('change', handleFilterChange);

    function handleFilterChange() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const category = document.getElementById('category-filter').value;
      const filtered = allCaterers.filter(caterer => {
        const matchName = caterer.businessName?.toLowerCase().includes(searchTerm);
        const matchCat = category === 'all' || caterer.category === category;
        return matchName && matchCat;
      });
      renderCaterers(filtered);
    }

    // === CART LOGIC ===
    let lastCartItems = []; // Keep track of items for placing order

    function listenForCartUpdates() {
      if (cartUnsubscribe) cartUnsubscribe();
      const cartQuery = query(collection(db, "cart"), where("userId", "==", currentUser.uid));
      cartUnsubscribe = onSnapshot(cartQuery, snapshot => {
        const cartItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        lastCartItems = cartItems;
        updateCartUI(cartItems);
      }, err => {
        showToast("Cart error: " + err.message);
        console.error(err);
      });
    }

    function updateCartUI(cartItems) {
      const cartDiv = document.getElementById('cart-items');
      const totalDiv = document.getElementById('cart-total');
      cartDiv.innerHTML = '';
      if (cartItems.length === 0) {
        cartDiv.innerHTML = `<div class="empty-state">Your cart is empty.</div>`;
        totalDiv.textContent = "";
        return;
      }
      cartDiv.innerHTML = cartItems.map(item => `
        <div class="cart-item list-item">
          <span>${item.productName || 'Unnamed Item'}</span>
          <span>â‚¹${item.price || 0} Ã— ${item.quantity || 1}</span>
        </div>
      `).join('');
      const sum = cartItems.reduce((acc, item) => acc + (item.price || 0) * (item.quantity || 1), 0);
      totalDiv.textContent = `Total: â‚¹${sum.toFixed(2)}`;
    }

    document.querySelector('.place-order-btn').addEventListener('click', async () => {
      if (lastCartItems.length === 0) {
        return showToast("Your cart is empty.");
      }
      const batch = writeBatch(db);
      const caterers = new Set(lastCartItems.map(item => item.catererId));
      const total = lastCartItems.reduce((acc, item) => acc + (item.price || 0) * (item.quantity || 1), 0);
      
      const orderRef = doc(collection(db, "orders"));
      batch.set(orderRef, {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        items: lastCartItems,
        catererIds: Array.from(caterers),
        totalPrice: total,
        status: "Pending",
        timestamp: serverTimestamp()
      });
      
      // Delete items from cart
      lastCartItems.forEach(item => {
        batch.delete(doc(db, "cart", item.id));
      });

      try {
        await batch.commit();
        showToast("Order placed successfully!");
      } catch (e) {
        showToast("Order failed: " + e.message);
        console.error("Order placement error:", e);
      }
    });

    // === ORDER HISTORY ===
    async function loadOrderHistory() {
      try {
        const ordersRef = collection(db, "orders");
        const q = query(ordersRef, where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"));
        const snapshot = await getDocs(q);
        const historyDiv = document.getElementById('order-history');
        historyDiv.innerHTML = '';
        if (snapshot.empty) {
          historyDiv.innerHTML = '<div class="empty-state">You have no past orders.</div>';
          return;
        }
        snapshot.forEach(docSnap => {
          const order = docSnap.data();
          const time = order.timestamp?.toDate().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }) || "N/A";
          const productsDisplay = order.items?.map(i => `${i.productName} (Ã—${i.quantity || 1})`).join(', ') || '';
          const div = document.createElement('div');
          div.className = 'order-item list-item';
          div.innerHTML = `
            <div><strong>Order #${docSnap.id.substring(0, 6).toUpperCase()}</strong> on ${time}</div>
            <div><b>Items:</b> ${productsDisplay}</div>
            <div><b>Total:</b> â‚¹${order.totalPrice.toFixed(2)}</div>
            <div class="order-status">Status: ${order.status}</div>
          `;
          historyDiv.appendChild(div);
        });
      } catch (error) {
        showToast("Could not load order history.");
        console.error("Error loading orders: ", error);
      }
    }
  </script>
</body>
</html>